<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>QuickSurf – mini html proxy</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<style>
  body{font-family:system-ui;background:#111;color:#eee;margin:0;padding:1rem}
  input,button{font-size:1rem;padding:.5rem;border:none;border-radius:4px}
  input{width:70%}
  button{background:#0bf;color:#000;cursor:pointer}
  iframe{width:100%;height:85vh;border:none;margin-top:1rem;background:#fff}
  #load{text-align:center;margin-top:2rem;font-size:1.2rem}
</style>
</head>
<body>

<h1>QuickSurf</h1>
<input id="url" placeholder="https://example.com" value="">
<button onclick="go()">Go</button>
<button onclick="history.back()">◀</button>
<button onclick="history.forward()">▶</button>
<button onclick="location.reload()">↻</button>

<div id="load"></div>
<iframe id="frame" hidden></iframe>

<script>
/* ---------- CONFIGURATION ---------- */
const PROXY_PATH = window.location.pathname.replace(/\/[^\/]*$/,'') + '/px/'; // must match base + /px/
/* ----------------------------------- */

function go(){
  let url = document.getElementById('url').value.trim();
  if(!/^https?:\/\//i.test(url)) url = 'https://' + url;
  document.getElementById('load').textContent = 'loading …';
  document.getElementById('frame').hidden = false;
  document.getElementById('frame').src = PROXY_PATH + encodeURIComponent(url);
}

/* ---------- SERVICE-WORKER ---------- */
/* Tiny SW that intercepts any request for /px/* and fetches the real page */
const SW = `
self.addEventListener('fetch', e => {
  const url = new URL(e.request.url);
  if(!url.pathname.startsWith('${PROXY_PATH}')) return;
  const target = decodeURIComponent(url.pathname.replace('${PROXY_PATH}',''));
  e.respondWith(
    fetch(target,{referrer:'',mode:'cors',credentials:'omit'})
      .then(r => r.text())
      .then(html => {
        /* rewrite links, imgs, scripts, css so they stay inside proxy */
        const base = '<base href="'+target.replace(/\\/[^\\/]*$/,'/')+'">';
        html = html.replace(/<head[^>]*>/i,'$&'+base);
        html = html.replace(
          /((href|src|action)\\s*=\\s*["'])(\\/[^\\/])/gi,
          '$1'+target.replace(/\\/[^\\/]*$/,'')+'$3'
        );
        html = html.replace(
          /((href|src|action)\\s*=\\s*["'])(?!https?:\\/\\/)([^"#]+)/gi,
          '$1'+ '${PROXY_PATH}' + encodeURIComponent('$3')
        );
        return new Response(html,{
          headers:{'Content-Type':'text/html;charset=utf-8'}
        });
      })
      .catch(() => new Response('Blocked or offline.',{status:404}))
  );
});
`;
/* ------------------------------------ */

/* auto-install service-worker if not present */
if('serviceWorker' in navigator){
  const blob = new Blob([SW],{type:'application/javascript'});
  const swURL = URL.createObjectURL(blob);
  navigator.serviceWorker.register(swURL,{scope:PROXY_PATH});
}
</script>

</body>
</html>
